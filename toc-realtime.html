<script>
  const activeClass = 'active';
  const toc = document.querySelector('.blog__toc-list');
  const content = document.querySelector('.blog__richtext');
  const collectHeadings = 'h1,h2,h3';

  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        const id = entry.target.getAttribute('id');
        if (entry.isIntersecting) {
          document.querySelectorAll(`.${activeClass}`).forEach((z) => z.classList.remove(activeClass));
          document.querySelector(`a[href="#${id}"]`).classList.add(activeClass);
        }
      });
    },
    { rootMargin: '-155px 0px -75% 0px' }
  );

  content.querySelectorAll(collectHeadings).forEach((heading, i) => {
    observer.observe(heading);
    let str = heading.innerHTML;
    str = str.replace(/[Â°&\/\\#,+()$~%.'":;*?<>{}0-9]/g, '').replace(/\s+/g, '-');
    heading.setAttribute('id', str);
    const item = document.createElement('a');
    item.innerHTML = heading.innerHTML;
    collectHeadings.split(',').forEach((tag) => {
      if (heading.tagName.toLowerCase() == tag) item.classList.add('toc__item', `toc-${tag}`);
      if (heading.tagName.toLowerCase() == 'h3') item.classList.add('is--indented');
    });
    item.setAttribute('href', `#${str}`);
    toc.appendChild(item);

    item.addEventListener('click', (e) => {
      e.preventDefault();
      const target = document.querySelector(item.getAttribute('href'));
      const offset = 155;
      const scrollOptions = {
        top: target.getBoundingClientRect().top + window.pageYOffset - offset,
        behavior: 'smooth',
      };
      window.scrollTo(scrollOptions);
    });
  });
</script>
